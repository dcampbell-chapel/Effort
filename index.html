<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Behavior Tracker — Final</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
      --accent: #dc2626;
      --muted: #6b7280;
      --bg: #f8fafc;
      --panel: #ffffff;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
    }

    html,body { height:100%; }
    body {
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: #111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding: 1rem;
    }

    .container { max-width: 1152px; margin: 0 auto; }

    header { margin-bottom: 1rem; }
    .title { color: var(--accent); font-size: 1.5rem; font-weight:700; margin:0; }
    .lead { color: var(--muted); margin-top:0.25rem; margin-bottom:0.5rem; }

    /* Action bar */
    .action-bar {
      display:flex;
      justify-content:space-between;
      gap:1rem;
      align-items:center;
      background:var(--panel);
      padding:1rem;
      border-radius:0.75rem;
      box-shadow: var(--shadow);
      margin-bottom:1rem;
      flex-wrap:wrap;
    }

    .controls { display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; }
    label { font-weight:600; color: #374151; font-size:0.95rem; display:flex; align-items:center; gap:0.5rem; }
    .form-control { padding:0.5rem 0.6rem; border-radius:0.5rem; border:1px solid #e6e9ee; background:#fff; min-width:140px; }

    .btn {
      background:var(--accent); color:#fff; border:none; padding:0.45rem 0.75rem; border-radius:0.5rem; cursor:pointer; font-weight:600;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .btn.secondary { background:#475569; }

    /* Panels */
    .panel {
      background:var(--panel); padding:1rem; border-radius:0.75rem; box-shadow: var(--shadow); margin-bottom:1rem;
    }

    /* Grid layout */
    .main-grid {
      display:grid;
      grid-template-columns: 1.5fr repeat(5, 1fr);
      border-radius: 0.5rem;
      overflow:hidden;
      border:1px solid #eef2f7;
    }
    .grid-header-cell {
      background:#f3f4f6; font-weight:700; padding:0.6rem; text-align:center; color:#374151; border-bottom:1px solid #eef2f7;
    }
    .grid-row-cell { padding:0.6rem; text-align:center; border-bottom:1px solid #f6f7fb; font-size:0.95rem; }
    .grid-row-name { text-align:left; font-weight:600; padding-left:0.8rem; }
    .incident-cell { display:flex; align-items:center; justify-content:center; height:48px; cursor:pointer; font-size:1.2rem; transition:background .15s; }
    .incident-cell:hover { background:#fff1f1; }
    .incident-cell.logged { background:#fee2e2; color:#7f1d1d; font-weight:700; }

    /* Charts */
    .chart-controls { display:flex; gap:1rem; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap; }
    .range { display:flex; gap:0.5rem; align-items:center; }
    .range input[type="range"] { width:260px; }
    .chart-wrap { width:100%; height:420px; border-radius:0.5rem; background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(250,250,251,0.8)); padding:0.5rem; box-sizing:border-box; }

    /* Modal */
    .modal-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(2,6,23,0.6); z-index:50; }
    .modal-overlay.visible { display:flex; }
    .modal { background:var(--panel); border-radius:0.75rem; width:100%; max-width:720px; padding:0.75rem; box-shadow: 0 30px 60px rgba(2,6,23,0.25); }
    .student-list-item { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom: 1px solid #f3f4f6; }

    small.muted { color:var(--muted); }
    @media (max-width:720px) {
      .main-grid { grid-template-columns: 1fr repeat(5, 64px); }
      .chart-wrap { height:320px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="title">Student Behavior Tracker</h1>
      <p class="lead">Tracker grid + interactive charts. Click a cell to toggle an incident; use the slider to change the date window.</p>
    </header>

    <!-- top controls -->
    <div class="action-bar">
      <div class="controls">
        <label>Date: <input id="date-picker" class="form-control" type="date"></label>
        <label>Class:
          <select id="class-filter-select" class="form-control"></select>
        </label>
        <label>Student:
          <select id="student-select" class="form-control"><option value="">-- Select Student --</option></select>
        </label>
        <div id="user-id-display" style="margin-left:8px;color:var(--muted);font-weight:600;">User: loading...</div>
      </div>

      <div style="display:flex; gap:0.5rem; align-items:center;">
        <button id="manage-btn" class="btn"><i class="fas fa-users-cog"></i> Manage</button>
        <button id="show-summary-btn" class="btn secondary">Show Summary</button>
      </div>
    </div>

    <!-- Tracker grid -->
    <div id="tracker-panel" class="panel">
      <div id="tracker-grid" aria-live="polite">Loading tracker...</div>
    </div>

    <!-- Charts area -->
    <div class="panel">
      <div class="chart-controls">
        <div class="range">
          <strong style="color:#111827">Window:</strong>
          <span style="color:var(--muted)">last </span>
          <span id="range-days" style="font-weight:700; color:var(--accent); margin:0 0.25rem;">21</span>
          <span style="color:var(--muted)">days</span>
        </div>

        <input id="range-slider" type="range" min="7" max="180" step="1" value="21" />

        <div style="margin-left:auto; display:flex; gap:0.5rem;">
          <button id="btn-refresh" class="btn secondary">Refresh</button>
        </div>
      </div>

      <div class="chart-wrap">
        <canvas id="lineChart" style="width:100%;height:100%"></canvas>
        <canvas id="donutChart" style="width:100%;height:100%; display:none; margin-top:0.5rem;"></canvas>
      </div>
    </div>
  </div>

  <!-- Manage students modal -->
  <div id="manage-students-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
        <h3 style="margin:0;color:var(--accent)">Manage Students</h3>
        <button onclick="closeModal('manage-students-modal')" class="btn secondary">Close</button>
      </div>

      <div style="display:flex;gap:0.5rem;margin-bottom:0.75rem;">
        <input id="new-student-name" placeholder="Name" class="form-control" />
        <input id="new-student-class" placeholder="Class" class="form-control" />
        <button class="btn" onclick="addStudent()">Add</button>
      </div>

      <div id="student-list-container" style="max-height:300px; overflow:auto;"></div>
    </div>
  </div>

  <script type="module">
  // ---------------------------
  // Final app: Firebase + Charts
  // ---------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  const { Chart } = window;

  // --- Config (your Firebase project) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDlsGbo2qdX9HkLbwPYIyvDGDEsWrIboXY",
    authDomain: "effort-51e3c.firebaseapp.com",
    projectId: "effort-51e3c",
    storageBucket: "effort-51e3c.firebasestorage.app",
    messagingSenderId: "182442171",
    appId: "1:182442171:web:b64125daa653c82855319e",
    measurementId: "G-YQ70LMPHX8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- App state ---
  let userId = null;
  let students = []; // sorted by first name
  let incidentsByDate = {}; // { 'YYYY-MM-DD': { 'studentId-category': { ... } } }
  let currentTrackingDate = new Date().toISOString().split('T')[0];
  let currentClassFilter = 'All';
  let windowDays = 21; // slider (7..180)

  const behaviorCategories = [
    { id:1, name:'On Time', color:'#10b981' },
    { id:2, name:'Materials', color:'#3b82f6' },
    { id:3, name:'Disruption', color:'#ef4444' },
    { id:4, name:'Out of Class', color:'#f59e0b' },
    { id:5, name:'Deadlines', color:'#8b5cf6' }
  ];

  const STUDENTS_COLLECTION = () => `artifacts/effort-51e3c/users/${userId}/students`;
  const INCIDENTS_COLLECTION = () => `artifacts/effort-51e3c/users/${userId}/incidents`;

  // utility
  const formatDate = d => d.toISOString().split('T')[0];
  function lastNDates(n){
    const base = new Date();
    const arr = [];
    for(let i=n-1;i>=0;i--){
      const d = new Date(base);
      d.setDate(base.getDate() - i);
      arr.push(formatDate(d));
    }
    return arr;
  }

  // debounce
  let sliderTimer = null;
  function debounce(fn, wait=180){
    if(sliderTimer) clearTimeout(sliderTimer);
    sliderTimer = setTimeout(fn, wait);
  }

  // DOM refs
  const trackerGridEl = document.getElementById('tracker-grid');
  const classSelectEl = document.getElementById('class-filter-select');
  const studentSelectEl = document.getElementById('student-select');
  const datePickerEl = document.getElementById('date-picker');
  const rangeDaysEl = document.getElementById('range-days');
  const rangeSliderEl = document.getElementById('range-slider');
  const userDisplayEl = document.getElementById('user-id-display');
  const showSummaryBtn = document.getElementById('show-summary-btn');
  const lineCanvas = document.getElementById('lineChart');
  const donutCanvas = document.getElementById('donutChart');
  const manageBtn = document.getElementById('manage-btn');
  const manageModal = document.getElementById('manage-students-modal');
  const studentListContainer = document.getElementById('student-list-container');

  // Charts
  let lineChart = null;
  let donutChart = null;

  // -----------------------
  // Initialization & Auth
  // -----------------------
  async function init(){
    // sign in anonymously
    try {
      await signInAnonymously(auth);
    } catch (e) {
      console.warn('anonymous sign-in error', e);
    }

    // only start listeners AFTER we have a user
    onAuthStateChanged(auth, user => {
      if (user) {
        userId = user.uid;
        userDisplayEl.textContent = `User: ${userId.substring(0,8)}...`;
        trackerGridEl.innerHTML = '<div style="padding:1rem;color:var(--muted)">Loading data…</div>';
        startListeners();
        // set datepicker max and value
        datePickerEl.max = formatDate(new Date());
        datePickerEl.value = currentTrackingDate;
        // range slider setup
        rangeDaysEl.textContent = windowDays;
        rangeSliderEl.value = windowDays;
        // initial charts placeholders
        renderEmptyCharts();
      } else {
        userDisplayEl.textContent = 'User: not signed in';
        trackerGridEl.innerHTML = '<div style="padding:1rem;color:var(--muted)">Unable to connect to Firebase.</div>';
      }
    });
  }

  // -----------------------
  // Firestore listeners
  // -----------------------
  function startListeners(){
    // students
    onSnapshot(collection(db, STUDENTS_COLLECTION()), snap => {
      students = snap.docs.map(d => ({ id:d.id, ...d.data() }))
        .sort((a,b) => {
          const aFirst = (a.name||'').split(' ')[0].toLowerCase();
          const bFirst = (b.name||'').split(' ')[0].toLowerCase();
          return aFirst.localeCompare(bFirst);
        });
      updateClassOptions();
      updateStudentSelect();
      renderGrid();
      updateCharts();
    }, err => {
      console.error('students listen', err);
      trackerGridEl.innerHTML = '<div style="padding:1rem;color:var(--muted)">Error loading students.</div>';
    });

    // incidents
    onSnapshot(collection(db, INCIDENTS_COLLECTION()), snap => {
      const map = {};
      snap.docs.forEach(docSnap => {
        const data = docSnap.data();
        const date = data.date;
        const key = `${data.studentId}-${data.category}`;
        if (!map[date]) map[date] = {};
        map[date][key] = { ...data, docId: docSnap.id };
      });
      incidentsByDate = map;
      renderGrid();
      updateCharts();
    }, err => {
      console.error('incidents listen', err);
    });
  }

  // -----------------------
  // UI rendering & actions
  // -----------------------
  function renderGrid(){
    if (!students.length) {
      trackerGridEl.innerHTML = '<div style="padding:1rem;color:var(--muted)">No students yet. Add students via Manage.</div>';
      return;
    }

    const filtered = currentClassFilter === 'All' ? students : students.filter(s => s.class === currentClassFilter);
    if (!filtered.length) {
      trackerGridEl.innerHTML = '<div style="padding:1rem;color:var(--muted)">No students in this class.</div>';
      return;
    }

    const parts = [];
    parts.push(`<div class="main-grid">
      <div class="grid-header-cell">Student</div>
      ${behaviorCategories.map(c=>`<div class="grid-header-cell">${c.name}</div>`).join('')}
    `);

    for (const s of filtered){
      parts.push(`<div class="grid-row-name grid-row-cell">${escapeHtml(s.name)} <small class="muted">(${escapeHtml(s.class||'')})</small></div>`);
      for (const c of behaviorCategories){
        const key = `${s.id}-${c.id}`;
        const logged = incidentsByDate[currentTrackingDate] && incidentsByDate[currentTrackingDate][key];
        parts.push(`<div class="grid-row-cell incident-cell ${logged ? 'logged' : ''}" onclick="toggleIncident('${s.id}', ${c.id})">${logged ? '❌' : '○'}</div>`);
      }
    }

    parts.push('</div>');
    trackerGridEl.innerHTML = parts.join('');
  }

  // escape small helper
  function escapeHtml(str){ return str ? String(str).replace(/[&<>"'`=\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s])) : ''; }

  // Manage students modal
  manageBtn.addEventListener('click', () => {
    manageModal.classList.add('visible');
    renderStudentList();
  });
  window.closeModal = (id) => document.getElementById(id).classList.remove('visible');

  function renderStudentList(){
    studentListContainer.innerHTML = students.map(s => `
      <div class="student-list-item">
        <div><strong>${escapeHtml(s.name)}</strong> <small class="muted">${s.class ? '('+escapeHtml(s.class)+')' : ''}</small></div>
        <div><button class="btn secondary" onclick="deleteStudent('${s.id}','${escapeHtml(s.name)}')">Delete</button></div>
      </div>
    `).join('');
  }

  window.addStudent = async function(){
    const name = document.getElementById('new-student-name').value.trim();
    const cls = document.getElementById('new-student-class').value.trim() || 'Unassigned';
    if (!name) return alert('Enter a name');
    await addDoc(collection(db, STUDENTS_COLLECTION()), { name, class: cls, createdAt: Date.now() });
    document.getElementById('new-student-name').value = '';
    document.getElementById('new-student-class').value = '';
  };

  window.deleteStudent = async function(id, name){
    if (!confirm(`Delete ${name} and all incidents?`)) return;
    // delete incidents for student
    const q = query(collection(db, INCIDENTS_COLLECTION()), where('studentId', '==', id));
    const snap = await getDocs(q);
    await Promise.all(snap.docs.map(d => deleteDoc(doc(db, INCIDENTS_COLLECTION(), d.id))));
    await deleteDoc(doc(db, STUDENTS_COLLECTION(), id));
  };

  // Toggle incident
  window.toggleIncident = async function(studentId, categoryId){
    const key = `${studentId}-${categoryId}`;
    const existing = incidentsByDate[currentTrackingDate] && incidentsByDate[currentTrackingDate][key];
    if (existing) {
      await deleteDoc(doc(db, INCIDENTS_COLLECTION(), existing.docId));
    } else {
      await addDoc(collection(db, INCIDENTS_COLLECTION()), {
        studentId, category: categoryId, date: currentTrackingDate, timestamp: Date.now()
      });
    }
  };

  // class and student selects
  function updateClassOptions(){
    const classes = ['All', ...[...new Set(students.map(s => s.class).filter(Boolean))].sort()];
    classSelectEl.innerHTML = classes.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    classSelectEl.value = currentClassFilter;
  }

  function updateStudentSelect(){
    const prev = studentSelectEl.value;
    studentSelectEl.innerHTML = '<option value="">-- Select Student --</option>' + students.map(s => `<option value="${s.id}">${escapeHtml(s.name)}${s.class ? ' ('+escapeHtml(s.class)+')' : ''}</option>`).join('');
    if (prev && students.some(s=>s.id===prev)) studentSelectEl.value = prev;
  }

  // event wiring
  classSelectEl.addEventListener('change', (e) => {
    currentClassFilter = e.target.value;
    renderGrid();
    updateCharts();
  });

  studentSelectEl.addEventListener('change', () => {
    updateCharts();
  });

  datePickerEl.addEventListener('change', (e) => {
    currentTrackingDate = e.target.value;
    renderGrid();
  });

  // range slider wiring
  rangeSliderEl.addEventListener('input', (e) => {
    rangeDaysEl.textContent = e.target.value;
    debounce(() => {
      windowDays = Number(e.target.value);
      updateCharts();
    });
  });

  // refresh and show summary wiring
  document.getElementById('btn-refresh').addEventListener('click', () => {
    renderGrid();
    updateCharts();
  });

  showSummaryBtn.addEventListener('click', () => {
    const lc = lineCanvas;
    const dc = donutCanvas;
    if (dc.style.display === 'block') {
      dc.style.display = 'none';
      lc.style.display = 'block';
      showSummaryBtn.textContent = 'Show Summary';
    } else {
      dc.style.display = 'block';
      lc.style.display = 'none';
      showSummaryBtn.textContent = 'Show Chart';
      updateCharts();
    }
  });

  // -----------------------
  // Charts: line (categories) and donut (category totals)
  // -----------------------
  function renderEmptyCharts(){
    // create placeholder charts (empty)
    if (lineChart) { try { lineChart.destroy(); } catch(e){} }
    if (donutChart) { try { donutChart.destroy(); } catch(e){} }

    const ctxLine = lineCanvas.getContext('2d');
    lineChart = new Chart(ctxLine, {
      type:'line',
      data: { labels: lastNDates(windowDays).map(d => d.slice(5)), datasets: behaviorCategories.map(c => ({ label:c.name, data: Array(windowDays).fill(0), borderColor:c.color, backgroundColor:c.color, tension:0.25, fill:false })) },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
    });

    const ctxDonut = donutCanvas.getContext('2d');
    donutChart = new Chart(ctxDonut, {
      type:'doughnut',
      data: { labels: behaviorCategories.map(c=>c.name), datasets:[{ data: behaviorCategories.map(()=>0), backgroundColor: behaviorCategories.map(c=>c.color) }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
    });
  }

  function updateCharts(){
    // selected student (optional)
    const selectedStudentId = studentSelectEl.value || null;
    const days = Number(windowDays) || 21;
    const labels = lastNDates(days);

    // Build datasets per category for line chart
    const datasets = behaviorCategories.map(cat => {
      const data = labels.map(day => {
        const dayMap = incidentsByDate[day] || {};
        let count = 0;
        for (const k in dayMap) {
          const inc = dayMap[k];
          if (inc.category === cat.id) {
            if (selectedStudentId && inc.studentId !== selectedStudentId) continue;
            const st = students.find(s => s.id === inc.studentId);
            if (currentClassFilter !== 'All' && (!st || st.class !== currentClassFilter)) continue;
            count++;
          }
        }
        return count;
      });
      return { label: cat.name, data, borderColor: cat.color, backgroundColor: cat.color, tension:0.25, fill:false, pointRadius:3 };
    });

    // Replace line chart
    try { if (lineChart) lineChart.destroy(); } catch(e){}
    lineChart = new Chart(lineCanvas.getContext('2d'), {
      type: 'line',
      data: { labels: labels.map(d => d.slice(5)), datasets },
      options: {
        responsive: true,
        maintainAspectRatio:false,
        animation: { duration: 600, easing: 'easeOutQuart' },
        plugins: {
          legend: { position:'bottom' },
          tooltip: {
            callbacks: {
              label: context => `${context.dataset.label}: ${context.formattedValue}`
            }
          }
        },
        scales: {
          y: { beginAtZero:true, ticks:{ precision: 0 } },
          x: { ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit: 12 } }
        }
      }
    });

    // Build donut data: totals across window per category (respecting student/class filters)
    const counts = behaviorCategories.map(cat => 0);
    for (const day of labels) {
      const dayMap = incidentsByDate[day] || {};
      for (const k in dayMap) {
        const inc = dayMap[k];
        if (inc.category === undefined) continue;
        if (selectedStudentId && inc.studentId !== selectedStudentId) continue;
        const st = students.find(s => s.id === inc.studentId);
        if (currentClassFilter !== 'All' && (!st || st.class !== currentClassFilter)) continue;
        const idx = behaviorCategories.findIndex(b => b.id === inc.category);
        if (idx >= 0) counts[idx] += 1;
      }
    }

    try { if (donutChart) donutChart.destroy(); } catch(e){}
    donutChart = new Chart(donutCanvas.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: behaviorCategories.map(c => c.name),
        datasets: [{ data: counts, backgroundColor: behaviorCategories.map(c => c.color), hoverOffset: 8 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio:false,
        animation: { duration: 600 },
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  // -----------------------
  // Bootstrap
  // -----------------------
  // initial wiring
  datePickerEl.max = formatDate(new Date());
  datePickerEl.value = currentTrackingDate;
  studentSelectEl.value = '';
  rangeDaysEl.textContent = windowDays;
  rangeSliderEl.value = windowDays;

  // initialize + start listeners once signed in
  init();

  // small safety: expose update functions for debugging
  window.updateCharts = updateCharts;
  window.renderGrid = renderGrid;
  window.toggleIncident = window.toggleIncident;

  </script>
</body>
</html>
