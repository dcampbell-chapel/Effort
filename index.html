<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Behavior Tracker</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      padding: 1rem;
    }
    @media (min-width: 640px) {
      body { padding: 2rem; }
    }
    .container {
      max-width: 1152px;
      margin: auto;
    }
    .h1-title {
      font-size: 1.875rem;
      font-weight: 700;
      color: #b91c1c;
    }
    .action-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
      background: white;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    .btn-primary {
      background-color: #dc2626;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.15s;
    }
    .btn-primary:hover { background-color: #b91c1c; }
    .tracker-wrapper {
      background-color: white;
      border-radius: 0.75rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 2rem;
    }
    .main-grid {
      display: grid;
      grid-template-columns: 1fr repeat(5, minmax(70px, 0.5fr));
    }
    .grid-header {
      background-color: #e5e7eb;
      font-weight: 600;
      color: #4b5563;
    }
    .grid-header-cell {
      padding: 0.5rem;
      border-right: 1px solid #d1d5db;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .grid-row-cell {
      padding: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.875rem;
    }
    .grid-row-name {
      font-weight: 500;
      color: #111827;
    }
    .bg-odd { background: #ffffff; }
    .bg-even { background: #f3f4f6; }
    .incident-cell {
      cursor: pointer;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      transition: all 0.15s;
    }
    .incident-cell:hover { background-color: #e5e7eb; }
    .logged {
      background-color: #fca5a5;
      color: #991b1b;
      font-weight: 700;
    }
    .logged:hover { background-color: #f87171; }
    .report-section {
      background: #fef2f2;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    table.report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.875rem;
    }
    .report-table th, .report-table td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      text-align: center;
    }
    .report-table th { background: #f3f4f6; color: #374151; }
    .bg-today { background-color: #fef3c7 !important; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="h1-title">Daily Behavior Tracker</h1>
    <p style="color:#4b5563;">Click a cell to log an incident. Data syncs automatically with Firebase.</p>
    <p id="user-id-display" style="color:#9ca3af;font-size:0.75rem;">User ID: Loading...</p>

    <div class="action-bar">
      <div>
        <label>Date: <input type="date" id="date-picker" /></label>
        <label style="margin-left:1rem;">Class:
          <select id="class-filter-select"></select>
        </label>
      </div>
      <button class="btn-primary" onclick="openModal('manage-students-modal')">
        <i class="fas fa-users-cog"></i> Manage Students
      </button>
    </div>

    <div class="tracker-wrapper">
      <div id="tracker-grid" style="padding:1rem;text-align:center;color:#6b7280;">
        <i class="fas fa-spinner fa-spin"></i> Loading tracker...
      </div>
    </div>

    <div class="report-section">
      <h2 class="h1-title" style="font-size:1.5rem;">3-Week Reporting View</h2>
      <label for="report-student-select">Select Student:</label>
      <select id="report-student-select" onchange="renderReport()" class="form-control" style="margin-bottom:1rem;width:100%;"></select>
      <div id="report-view" style="background:#fff;padding:1rem;border-radius:0.5rem;">
        Select a student to view their 3-week report.
      </div>
    </div>
  </div>

  <div id="manage-students-modal" class="modal-overlay" style="display:none;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let db, auth, userId = 'loading';
    let students = [], incidentsByDate = {}, currentTrackingDate, currentClassFilter = 'All', isAuthReady = false;
    const appId = "effort-51e3c";

    const STUDENTS_COLLECTION = () => `artifacts/${appId}/users/${userId}/students`;
    const INCIDENTS_COLLECTION = () => `artifacts/${appId}/users/${userId}/incidents`;

    const formatDate = d => d.toISOString().split('T')[0];
    const today = formatDate(new Date());
    currentTrackingDate = today;

    const behaviorCategories = [
      { id: 1, name: "On Time" },
      { id: 2, name: "Materials" },
      { id: 3, name: "Disruption" },
      { id: 4, name: "Out of Class" },
      { id: 5, name: "Deadlines" }
    ];

    window.initializeFirebase = async () => {
      const firebaseConfig = {
        apiKey: "AIzaSyDlsGbo2qdX9HkLbwPYIyvDGDEsWrIboXY",
        authDomain: "effort-51e3c.firebaseapp.com",
        projectId: "effort-51e3c",
        storageBucket: "effort-51e3c.firebasestorage.app",
        messagingSenderId: "182442171",
        appId: "1:182442171:web:b64125daa653c82855319e"
      };
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      await new Promise(resolve => {
        const unsub = onAuthStateChanged(auth, async user => {
          unsub();
          if (user) userId = user.uid;
          else {
            const uc = await signInAnonymously(auth);
            userId = uc.user.uid;
          }
          isAuthReady = true;
          document.getElementById("user-id-display").textContent =
            `User ID: ${userId.substring(0,8)}...`;
          listenToStudents();
          listenToIncidents();
          resolve();
        });
      });
    };

    const listenToStudents = () => {
      if (!isAuthReady) return;
      onSnapshot(collection(db, STUDENTS_COLLECTION()), snap => {
        students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        students.sort((a,b) => a.name.localeCompare(b.name));
        updateClassFilterOptions();
        renderTracker();
        renderReport();
      });
    };

    const listenToIncidents = () => {
      if (!isAuthReady) return;
      onSnapshot(collection(db, INCIDENTS_COLLECTION()), snap => {
        const newMap = {};
        snap.docs.forEach(docSnap => {
          const data = docSnap.data();
          const key = `${data.studentId}-${data.category}`;
          if (!newMap[data.date]) newMap[data.date] = {};
          newMap[data.date][key] = { ...data, docId: docSnap.id };
        });
        incidentsByDate = newMap;
        renderTracker();
        renderReport();
      });
    };

    const getUniqueClasses = () => ['All', ...new Set(students.map(s => s.class).filter(Boolean)).values()];

    const updateClassFilterOptions = () => {
      const select = document.getElementById('class-filter-select');
      const classes = getUniqueClasses();
      select.innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');
      select.value = currentClassFilter;
      document.getElementById('date-picker').max = today;
      document.getElementById('date-picker').value = currentTrackingDate;
    };

    window.changeDate = e => { currentTrackingDate = e.target.value; renderTracker(); };
    window.changeClassFilter = e => { currentClassFilter = e.target.value; renderTracker(); };

    window.toggleIncident = async (sid, cid) => {
      const key = `${sid}-${cid}`;
      const dayData = incidentsByDate[currentTrackingDate] || {};
      const existing = dayData[key];
      if (existing) {
        await deleteDoc(doc(db, INCIDENTS_COLLECTION(), existing.docId));
      } else {
        await addDoc(collection(db, INCIDENTS_COLLECTION()), {
          studentId: sid, category: cid, date: currentTrackingDate, timestamp: Date.now()
        });
      }
    };

    window.renderTracker = () => {
      const container = document.getElementById('tracker-grid');
      if (userId === 'loading') {
        container.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
        return;
      }
      const filtered = students.filter(s => currentClassFilter === 'All' || s.class === currentClassFilter);
      if (!filtered.length) {
        container.innerHTML = '<div style="padding:1rem;">No students found.</div>';
        return;
      }
      const dayData = incidentsByDate[currentTrackingDate] || {};
      let html = `
        <div class="main-grid grid-header">
          <div class="grid-header-cell">Student</div>
          ${behaviorCategories.map(c=>`<div class="grid-header-cell">${c.name}</div>`).join('')}
        </div>`;
      filtered.forEach((s,i)=>{
        const rowClass = i%2===0?'bg-odd':'bg-even';
        html += `<div class="main-grid ${rowClass}">
          <div class="grid-row-cell grid-row-name">${s.name} <span style="color:#6b7280;font-size:0.75rem;">(${s.class})</span></div>
          ${behaviorCategories.map(c=>{
            const key = `${s.id}-${c.id}`;
            const logged = !!dayData[key];
            return `<div class="incident-cell ${logged?'logged':''}" onclick="toggleIncident('${s.id}',${c.id})">${logged?'❌':'○'}</div>`;
          }).join('')}
        </div>`;
      });
      container.innerHTML = html;
    };

    window.renderReport = () => {
      const select = document.getElementById('report-student-select');
      const view = document.getElementById('report-view');
      select.innerHTML =
        '<option value="">-- Select Student --</option>' +
        students.map(s=>`<option value="${s.id}">${s.name} (${s.class})</option>`).join('');
      const sid = select.value;
      if (!sid) { view.textContent = 'Select a student to view their report.'; return; }
      const todayD = new Date();
      const dates = Array.from({length:21},(_,i)=>{
        const d=new Date(todayD); d.setDate(todayD.getDate()-i);
        return d.toISOString().split('T')[0];
      }).reverse();
      let rows = '';
      dates.forEach(date=>{
        const incs = incidentsByDate[date]||{};
        const cells = behaviorCategories.map(c=>{
          const key = `${sid}-${c.id}`;
          const logged = incs[key];
          return `<td>${logged?'✔️':''}</td>`;
        }).join('');
        const todayClass = date===today?' class="bg-today"':'';
        rows += `<tr${todayClass}><td>${date}</td>${cells}</tr>`;
      });
      view.innerHTML = `<table class="report-table"><thead><tr><th>Date</th>${behaviorCategories.map(c=>`<th>${c.name}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table>`;
    };

    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('date-picker').max = today;
      document.getElementById('date-picker').value = today;
      initializeFirebase();
    });
  </script>
</body>
</html>
