<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Behavior Tracker (Shared Edition)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;,">

  <style>
    /* --- STYLES (unchanged from your working version) --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background:#f9fafb; min-height:100vh; padding:1rem; }
    @media(min-width:640px){body{padding:2rem;}}
    .container{max-width:1152px;margin:auto;}
    .h1-title{font-size:1.875rem;font-weight:700;color:#b91c1c;}
    .action-bar{display:flex;flex-direction:column;align-items:flex-start;margin-bottom:1.5rem;padding:1rem;background:#fff;border-radius:.75rem;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    @media(min-width:640px){.action-bar{flex-direction:row;align-items:center;justify-content:space-between;}}
    .action-group{display:flex;align-items:center;gap:1.5rem;margin-bottom:1rem;}
    @media(min-width:640px){.action-group{margin-bottom:0;}}
    .form-control{padding:.5rem;border:1px solid #d1d5db;border-radius:.5rem;}
    .btn-primary{background:#dc2626;color:white;padding:.5rem 1rem;border-radius:.5rem;font-weight:600;cursor:pointer;}
    .btn-primary:hover{background:#b91c1c;}
    .tracker-wrapper{background:white;border-radius:.75rem;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    .main-grid{display:grid;grid-template-columns:1fr repeat(5,minmax(60px,0.5fr));}
    @media(max-width:640px){.main-grid{grid-template-columns:1fr repeat(5,50px);}}
    .grid-header{background:#e5e7eb;font-weight:600;color:#4b5563;}
    .grid-row-cell{padding:.5rem;border-bottom:1px solid #e5e7eb;}
    .grid-row-name{font-weight:500;color:#111827;}
    .incident-cell{cursor:pointer;text-align:center;padding:.5rem;color:#9ca3af;}
    .incident-cell.logged{background:#fca5a5;color:#991b1b;font-weight:600;}
    .report-section{margin-top:2rem;padding:1rem;background:#fef2f2;border-radius:.75rem;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:all .3s;z-index:10;}
    .modal-overlay.visible{visibility:visible;opacity:1;}
    .modal-content{background:white;border-radius:.75rem;max-width:30rem;width:100%;overflow:hidden;}
    .modal-header{padding:1rem;background:#f3f4f6;display:flex;justify-content:space-between;align-items:center;}
    .modal-body-section{padding:1rem;}
    .student-list-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-bottom:1px solid #e5e7eb;}
    .btn-delete{color:#ef4444;background:#fef2f2;border:none;border-radius:9999px;padding:.25rem;}
  </style>
</head>

<body>
  <div class="container">
    <header class="header-section">
      <h1 class="h1-title">Daily Behavior Tracker</h1>
      <p style="color:#4b5563;">Shared version — all devices see and edit the same data in real time.</p>
    </header>

    <div class="action-bar">
      <div class="action-group">
        <div>
          <label>Date:</label>
          <input type="date" id="date-picker" class="form-control" onchange="changeDate(event)">
        </div>
        <div>
          <label>Class:</label>
          <select id="class-filter-select" class="form-control" onchange="changeClassFilter(event)"></select>
        </div>
      </div>
      <button class="btn-primary" onclick="openModal('manage-students-modal')"><i class="fas fa-users-cog"></i> Manage Students</button>
    </div>

    <div class="tracker-wrapper">
      <div id="tracker-grid" class="grid-row-cell text-gray-500" style="padding:1rem;">
        <i class="fas fa-spinner fa-spin"></i> Loading shared data...
      </div>
    </div>

    <div class="report-section">
      <h2 class="h1-title" style="font-size:1.5rem;">3-Week Reporting View</h2>
      <div>
        <label>Select Student:</label>
        <select id="report-student-select" class="form-control" onchange="renderReport()">
          <option value="">-- Select Student --</option>
        </select>
      </div>
      <div id="report-view" style="margin-top:1rem;color:#6b7280;">Select a student to view their report.</div>
    </div>
  </div>

  <!-- MANAGE STUDENTS MODAL -->
  <div id="manage-students-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="h1-title" style="font-size:1.25rem;">Manage Students</h3>
        <button onclick="closeModal('manage-students-modal')"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body-section">
        <h4>Add New Student</h4>
        <div style="display:flex;gap:.5rem;margin-bottom:1rem;">
          <input type="text" id="new-student-name" placeholder="Name" class="form-control">
          <input type="text" id="new-student-class" placeholder="Class" class="form-control">
          <button class="btn-primary" onclick="addStudent()"><i class="fas fa-plus"></i></button>
        </div>
        <h4>Current Students</h4>
        <div id="student-list-container" style="max-height:15rem;overflow-y:auto;"></div>
      </div>
      <div class="modal-body-section" style="text-align:right;">
        <button class="btn-primary" onclick="closeModal('manage-students-modal')">Done</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, query, where, getDocs } 
      from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 🔥 Shared version: everyone uses the same data path
    const firebaseConfig = {
      apiKey: "AIzaSyDlsGbo2qdX9HkLbwPYIyvDGDEsWrIboXY",
      authDomain: "effort-51e3c.firebaseapp.com",
      projectId: "effort-51e3c",
      storageBucket: "effort-51e3c.firebasestorage.app",
      messagingSenderId: "182442171",
      appId: "1:182442171:web:b64125daa653c82855319e",
      measurementId: "G-YQ70LMPHX8"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appId = "effort-51e3c";
    const userId = "c6fpAFHWGwZGmCFImvcaQxR4zfs1";
    console.log("🔥 Shared mode active — all devices share the same data.");

    const STUDENTS_COLLECTION = () => `artifacts/${appId}/users/${userId}/students`;
    const INCIDENTS_COLLECTION = () => `artifacts/${appId}/users/${userId}/incidents`;

    let students = [];
    let incidentsByDate = {};
    let currentTrackingDate = new Date().toISOString().split('T')[0];
    let currentClassFilter = 'All';

    const behaviorCategories = [
      { id:1, name:"On Time", icon:"fas fa-clock" },
      { id:2, name:"Materials", icon:"fas fa-pencil-ruler" },
      { id:3, name:"Disruption", icon:"fas fa-exclamation-triangle" },
      { id:4, name:"Out of Class", icon:"fas fa-door-open" },
      { id:5, name:"Deadlines", icon:"fas fa-clipboard-check" }
    ];

    const listenToStudents = () => {
      onSnapshot(collection(db, STUDENTS_COLLECTION()), snap => {
        students = snap.docs.map(d => ({ id:d.id, ...d.data() })).sort((a,b)=>a.name.localeCompare(b.name));
        updateClassFilterOptions();
        renderTracker();
        renderStudentManagementList();
        renderReport();
      });
    };
    const listenToIncidents = () => {
      onSnapshot(collection(db, INCIDENTS_COLLECTION()), snap => {
        const newInc = {};
        snap.docs.forEach(docSnap => {
          const d = docSnap.data(); const docId = docSnap.id;
          if (!newInc[d.date]) newInc[d.date] = {};
          newInc[d.date][`${d.studentId}-${d.category}`] = { ...d, docId };
        });
        incidentsByDate = newInc;
        renderTracker();
        renderReport();
      });
    };
    listenToStudents(); listenToIncidents();

    const getUniqueClasses = () => ['All', ...[...new Set(students.map(s=>s.class).filter(Boolean))].sort()];
    const updateClassFilterOptions = () => {
      const sel = document.getElementById('class-filter-select');
      sel.innerHTML = getUniqueClasses().map(c=>`<option value="${c}" ${c===currentClassFilter?'selected':''}>${c}</option>`).join('');
      const dp = document.getElementById('date-picker');
      dp.max = new Date().toISOString().split('T')[0];
      dp.value = currentTrackingDate;
    };

    window.changeClassFilter = e => { currentClassFilter=e.target.value; renderTracker(); };
    window.changeDate = e => { currentTrackingDate=e.target.value; renderTracker(); };

    window.toggleIncident = async (sid,cid) => {
      const key = `${sid}-${cid}`, incs = incidentsByDate[currentTrackingDate]||{}, ex = incs[key];
      if (ex) await deleteDoc(doc(db, INCIDENTS_COLLECTION(), ex.docId));
      else await addDoc(collection(db, INCIDENTS_COLLECTION()), {studentId:sid,category:cid,date:currentTrackingDate,timestamp:Date.now()});
    };

    window.renderTracker = () => {
      const grid=document.getElementById('tracker-grid');
      const filtered=students.filter(s=>currentClassFilter==='All'||s.class===currentClassFilter);
      if(!filtered.length){grid.innerHTML='<div style="padding:1rem;">No students found.</div>';return;}
      const incs=incidentsByDate[currentTrackingDate]||{};
      grid.innerHTML=`
        <div class="main-grid grid-header">
          <div class="grid-header-cell">Student Name</div>
          ${behaviorCategories.map(c=>`<div class="grid-header-cell"><i class="${c.icon}"></i> ${c.name}</div>`).join('')}
        </div>
        ${filtered.map((s,i)=>`
          <div class="main-grid ${i%2?'bg-even':'bg-odd'}">
            <div class="grid-row-cell grid-row-name">${s.name} <span>(${s.class})</span></div>
            ${behaviorCategories.map(c=>{
              const key=`${s.id}-${c.id}`, logged=!!incs[key];
              return `<div class="incident-cell ${logged?'logged':''}" onclick="toggleIncident('${s.id}',${c.id})">${logged?'❌':'○'}</div>`;
            }).join('')}
          </div>`).join('')}
      `;
    };

    window.addStudent=async()=>{const n=document.getElementById('new-student-name').value.trim();const c=document.getElementById('new-student-class').value.trim()||'Unassigned';if(!n)return;await addDoc(collection(db,STUDENTS_COLLECTION()),{name:n,class:c,createdAt:Date.now()});document.getElementById('new-student-name').value='';document.getElementById('new-student-class').value='';};
    window.deleteStudent=async(id)=>{const q=query(collection(db,INCIDENTS_COLLECTION()),where("studentId","==",id));const s=await getDocs(q);await Promise.all(s.docs.map(d=>deleteDoc(d.ref)));await deleteDoc(doc(db,STUDENTS_COLLECTION(),id));};
    window.renderStudentManagementList=()=>{document.getElementById('student-list-container').innerHTML=students.map(s=>`<div class="student-list-item"><span>${s.name} (${s.class})</span><button class="btn-delete" onclick="deleteStudent('${s.id}')"><i class="fas fa-trash-alt"></i></button></div>`).join('');};

    window.openModal=id=>{document.getElementById(id).classList.add('visible');};
    window.closeModal=id=>{document.getElementById(id).classList.remove('visible');};

    window.renderReport=()=>{const s=document.getElementById('report-student-select');s.innerHTML='<option value="">-- Select Student --</option>'+students.map(st=>`<option value="${st.id}">${st.name} (${st.class})</option>`).join('');};

    document.addEventListener('DOMContentLoaded',()=>{const d=document.getElementById('date-picker');d.max=currentTrackingDate;d.value=currentTrackingDate;});
  </script>
</body>
</html>
