<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Behavior Tracker</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />

  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f9fafb;
      margin: 0;
      padding: 0;
    }

    header {
      text-align: center;
      padding: 2rem 1rem 1rem;
    }

    h1 {
      color: #b91c1c;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .action-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem 2rem;
      border-radius: 0.75rem;
      max-width: 900px;
      margin: 0 auto 2rem;
    }

    label {
      font-weight: 600;
      color: #374151;
      margin-right: 0.5rem;
    }

    select,
    input[type="date"] {
      padding: 0.4rem 0.6rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .tracker-wrapper {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin: 0 auto;
      max-width: 1150px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1.5fr repeat(5, 1fr);
    }

    .grid-header {
      background-color: #e5e7eb;
      font-weight: 600;
      text-align: center;
    }

    .grid-header div {
      padding: 0.75rem;
      border-right: 1px solid #d1d5db;
    }

    .grid-row {
      display: contents;
    }

    .grid-cell {
      padding: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
      font-size: 0.9rem;
    }

    .grid-cell.name {
      font-weight: 600;
      text-align: left;
      padding-left: 1rem;
    }

    .incident-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      height: 36px;
      width: 36px;
      margin: 0 auto;
      border-radius: 50%;
      background-color: #f3f4f6;
      transition: all 0.2s;
    }

    .incident-btn:hover {
      background-color: #e5e7eb;
    }

    .incident-btn.logged {
      background-color: #fca5a5;
      color: #991b1b;
    }

    .grid-row:nth-child(even) .grid-cell {
      background-color: #f9fafb;
    }

    .report-section {
      background: #fef2f2;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 2.5rem auto;
      max-width: 1150px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .report-section h2 {
      color: #b91c1c;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    #report-view {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    canvas {
      width: 100% !important;
      height: 400px !important;
    }

    .loading {
      text-align: center;
      color: #6b7280;
      padding: 2rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Student Behavior Tracker</h1>
    <p id="user-id-display" style="color: #6b7280; font-size: 0.9rem">
      User ID: Loading...
    </p>
  </header>

  <div class="action-bar">
    <div>
      <label for="grade-select">Grade:</label>
      <select id="grade-select" onchange="changeGrade(event)">
        <option value="grade9">Grade 9</option>
        <option value="grade11">Grade 11</option>
      </select>
    </div>

    <div>
      <label for="class-select">Class:</label>
      <select id="class-select" onchange="changeClassFilter(event)">
        <option value="All">All</option>
      </select>
    </div>

    <div>
      <label for="date-picker">Date:</label>
      <input type="date" id="date-picker" onchange="changeDate(event)" />
    </div>
  </div>

  <div id="tracker-container" class="tracker-wrapper">
    <div id="tracker-grid" class="loading">
      <i class="fas fa-spinner fa-spin"></i> Loading tracker...
    </div>
  </div>

  <div class="report-section">
    <h2>3-Week Reporting View</h2>
    <div style="margin-bottom: 1rem">
      <label for="report-student-select">Select Student:</label>
      <select id="report-student-select" onchange="renderReport()">
        <option value="">-- Select Student --</option>
      </select>
    </div>
    <div id="report-view">
      <p class="loading">
        Select a student to view their 3-week incident chart.
      </p>
    </div>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      deleteDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDlsGbo2qdX9HkLbwPYIyvDGDEsWrIboXY",
      authDomain: "effort-51e3c.firebaseapp.com",
      projectId: "effort-51e3c",
      storageBucket: "effort-51e3c.firebasestorage.app",
      messagingSenderId: "182442171",
      appId: "1:182442171:web:b64125daa653c82855319e",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userId = "loading";
    let currentGrade = "grade9";
    let currentClass = "All";
    let currentDate = new Date().toISOString().split("T")[0];
    let students = [];
    let incidentsByDate = {};
    let isAuthReady = false;
    let reportChart = null;

    const behaviorCategories = [
      { id: 1, name: "Tardy" },
      { id: 2, name: "Materials" },
      { id: 3, name: "Disruption" },
      { id: 4, name: "Out of Class" },
      { id: 5, name: "Deadlines" },
    ];

    function STUDENTS_COLLECTION() {
      return `artifacts/effort-51e3c/users/${userId}/courses/${currentGrade}/students`;
    }
    function INCIDENTS_COLLECTION() {
      return `artifacts/effort-51e3c/users/${userId}/courses/${currentGrade}/incidents`;
    }

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        const cred = await signInAnonymously(auth);
        userId = cred.user.uid;
      } else userId = user.uid;
      isAuthReady = true;
      document.getElementById(
        "user-id-display"
      ).textContent = `User ID: ${userId.substring(0, 8)}... (App: effort-51e3c)`;
      listenToStudents();
      listenToIncidents();
    });

    function listenToStudents() {
      if (!isAuthReady) return;
      const ref = collection(db, STUDENTS_COLLECTION());
      onSnapshot(ref, (snap) => {
        students = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        students.sort((a, b) => a.name.localeCompare(b.name));
        updateClassOptions();
        renderTracker();
        renderReport();
      });
    }

    function listenToIncidents() {
      if (!isAuthReady) return;
      const ref = collection(db, INCIDENTS_COLLECTION());
      onSnapshot(ref, (snap) => {
        incidentsByDate = {};
        snap.docs.forEach((docSnap) => {
          const data = docSnap.data();
          const key = `${data.date}`;
          if (!incidentsByDate[key]) incidentsByDate[key] = {};
          incidentsByDate[key][`${data.studentId}-${data.category}`] = {
            ...data,
            docId: docSnap.id,
          };
        });
        renderTracker();
        renderReport();
      });
    }

    function updateClassOptions() {
      const select = document.getElementById("class-select");
      const classes = [
        "All",
        ...new Set(students.map((s) => s.class).filter(Boolean)),
      ];
      select.innerHTML = classes
        .map(
          (c) =>
            `<option value="${c}" ${
              c === currentClass ? "selected" : ""
            }>${c}</option>`
        )
        .join("");
    }

    window.changeGrade = (e) => {
      currentGrade = e.target.value;
      listenToStudents();
      listenToIncidents();
    };

    window.changeClassFilter = (e) => {
      currentClass = e.target.value;
      renderTracker();
    };

    window.changeDate = (e) => {
      currentDate = e.target.value;
      renderTracker();
    };

    window.toggleIncident = async (studentId, categoryId) => {
      const dateIncidents = incidentsByDate[currentDate] || {};
      const key = `${studentId}-${categoryId}`;
      const existing = dateIncidents[key];
      if (existing) {
        await deleteDoc(doc(db, INCIDENTS_COLLECTION(), existing.docId));
      } else {
        await addDoc(collection(db, INCIDENTS_COLLECTION()), {
          studentId,
          category: categoryId,
          date: currentDate,
          timestamp: Date.now(),
        });
      }
    };

    window.renderTracker = () => {
      const grid = document.getElementById("tracker-grid");
      if (!students.length) {
        grid.innerHTML = `<div class='loading'>No students found.</div>`;
        return;
      }
      const dateIncidents = incidentsByDate[currentDate] || {};
      const filtered = students.filter(
        (s) => currentClass === "All" || s.class === currentClass
      );

      let html = `
        <div class="main-grid grid-header">
          <div>Student</div>
          ${behaviorCategories.map((c) => `<div>${c.name}</div>`).join("")}
        </div>
      `;
      filtered.forEach((s, i) => {
        html += `<div class="grid-row">
          <div class="grid-cell name">${s.name} <span style="color:#9ca3af; font-size:0.8rem;">(${s.class})</span></div>
          ${behaviorCategories
            .map((cat) => {
              const key = `${s.id}-${cat.id}`;
              const logged = dateIncidents[key];
              return `<div class="grid-cell"><div class="incident-btn ${
                logged ? "logged" : ""
              }" onclick="toggleIncident('${s.id}',${cat.id})">${
                logged
                  ? '<i class="fas fa-times-circle"></i>'
                  : '<i class="far fa-circle"></i>'
              }</div></div>`;
            })
            .join("")}
        </div>`;
      });

      grid.innerHTML = html;
    };

    window.renderReport = () => {
      const select = document.getElementById("report-student-select");
      const view = document.getElementById("report-view");
      select.innerHTML =
        '<option value="">-- Select Student --</option>' +
        students
          .map(
            (s) =>
              `<option value="${s.id}">${s.name} (${s.class || ""})</option>`
          )
          .join("");

      const studentId = select.value;
      if (!studentId) {
        view.innerHTML = `<p class="loading">Select a student to view their 3-week incident chart.</p>`;
        return;
      }

      const today = new Date();
      const startDate = new Date();
      startDate.setDate(today.getDate() - 20);
      const labels = [];
      const datasets = behaviorCategories.map((cat) => ({
        label: cat.name,
        data: [],
        borderWidth: 2,
        fill: false,
      }));

      for (let i = 0; i < 21; i++) {
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i);
        const dateKey = formatDate(d);
        labels.push(dateKey);
        behaviorCategories.forEach((cat, idx) => {
          let count = 0;
          if (incidentsByDate[dateKey]) {
            Object.values(incidentsByDate[dateKey]).forEach((incident) => {
              if (incident.studentId === studentId && incident.category === cat.id)
                count++;
            });
          }
          datasets[idx].data.push(count);
        });
      }

      const colors = ["#dc2626", "#f97316", "#facc15", "#22c55e", "#3b82f6"];
      datasets.forEach((d, i) => (d.borderColor = colors[i]));

      view.innerHTML = `<canvas id="report-chart"></canvas>`;
      const ctx = document.getElementById("report-chart");
      if (reportChart) reportChart.destroy();
      reportChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: {
              display: true,
              text: "3-Week Incident Trends",
              color: "#b91c1c",
              font: { size: 18, weight: "bold" },
            },
          },
          scales: {
            x: { ticks: { color: "#374151" } },
            y: { beginAtZero: true, ticks: { stepSize: 1 } },
          },
        },
      });
    };
  </script>
</body>
</html>
